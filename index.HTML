<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GPTrading Pro Dashboard</title>
  <style>
    :root {
      --primary: #0066ff;
      --secondary: #00d4aa;
      --success: #22c55e;
      --danger: #ef4444;
      --warning: #f59e0b;
      --dark: #0f172a;
      --dark-secondary: #1e293b;
      --light: #f8fafc;
      --text: #334155;
      --text-light: #64748b;
      --border: #e2e8f0;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --gradient-card: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--light);
      color: var(--text);
      line-height: 1.6;
    }

    .main-container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      background: var(--gradient-primary);
      border-radius: 20px;
      padding: 40px;
      margin-bottom: 30px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
      animation: shimmer 4s infinite linear;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%) skewX(-20deg); }
      100% { transform: translateX(100%) skewX(-20deg); }
    }

    .header h1 {
      color: white;
      font-size: 2.8rem;
      font-weight: 800;
      margin-bottom: 10px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .header p {
      color: rgba(255,255,255,0.9);
      font-size: 1.2rem;
      max-width: 800px;
      margin: 0 auto;
    }

    .controls-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: var(--shadow-lg);
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .controls-bar > div {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      position: relative;
      overflow: hidden;
    }

    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-secondary {
      background: var(--secondary);
      color: white;
    }
    
    .btn-warning {
        background: var(--warning);
        color: white;
    }

    .card {
      background: var(--gradient-card);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: var(--gradient-primary);
    }

    .card h2 {
      color: var(--dark);
      font-size: 1.6rem;
      font-weight: 700;
      margin-bottom: 25px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .input-group label {
      font-weight: 600;
      color: var(--text);
      font-size: 14px;
    }

    .form-control {
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.3s ease;
      background: white;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(0, 102, 255, 0.1);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: var(--shadow);
      text-align: center;
      position: relative;
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gradient-primary);
    }
    
    .stat-card.profit::before {
        background: var(--success);
    }
    .stat-card.loss::before {
        background: var(--danger);
    }

    .stat-value {
      font-size: 2.2rem;
      font-weight: 700;
      color: var(--dark);
      margin-bottom: 5px;
    }

    .stat-label {
      color: var(--text-light);
      font-size: 14px;
      font-weight: 500;
    }
    
    .stat-card.profit .stat-value {
      color: var(--success);
    }
    
    .stat-card.loss .stat-value {
      color: var(--danger);
    }

    .table-container {
      background: white;
      border-radius: 15px;
      overflow-x: auto; /* Permite scroll horizontal en pantallas pequeñas */
      box-shadow: var(--shadow-lg);
      margin-bottom: 30px;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px; /* Ancho mínimo para forzar el scroll si es necesario */
    }

    .table th {
      background: #f8fafc;
      color: var(--text-light);
      padding: 18px 15px;
      text-align: left;
      font-weight: 600;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid var(--border);
    }

    .table td {
      padding: 15px;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
      font-size: 14px;
      color: var(--text);
    }

    .table tbody tr:last-child td {
        border-bottom: none;
    }

    .table tbody tr:hover {
      background: #f1f5f9;
    }

    .badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: capitalize;
    }

    .badge-success {
      background: rgba(34, 197, 94, 0.1);
      color: var(--success);
    }

    .badge-danger {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
    }

    .chart-container {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: var(--shadow);
      margin-bottom: 30px;
    }

    .calculator-widget {
      background: var(--dark-secondary);
      color: white;
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
    }

    .calculator-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .calc-result {
      background: rgba(255,255,255,0.1);
      padding: 20px;
      border-radius: 10px;
      backdrop-filter: blur(10px);
      margin-top: 20px;
    }
    
    .dark-mode {
        --light: #0f172a;
        --dark: #f8fafc;
        --dark-secondary: #1e293b;
        --text: #e2e8f0;
        --text-light: #94a3b8;
        --border: #334155;
        --gradient-card: linear-gradient(145deg, #1e293b 0%, #334155 100%);
    }

    .dark-mode .card,
    .dark-mode .stat-card,
    .dark-mode .table-container,
    .dark-mode .chart-container,
    .dark-mode .controls-bar {
      background: var(--dark-secondary);
      color: var(--text);
      border-color: var(--border);
    }
    
    .dark-mode .card h2 {
        color: var(--dark);
    }

    .dark-mode .form-control {
      background: #0f172a;
      color: var(--text);
      border-color: var(--border);
    }

    .dark-mode .table th {
        background: #0f172a;
        border-color: var(--border);
        color: var(--text-light);
    }
    
    .dark-mode .table td {
        border-color: var(--border);
    }

    .dark-mode .table tbody tr:hover {
      background: #334155;
    }
    
    .dark-mode #capital-summary .account-div {
        background: var(--dark-secondary) !important;
        border-color: var(--primary) !important;
    }
    
    .dark-mode #capital-summary h4,
    .dark-mode #capital-summary p {
        color: var(--text) !important;
    }
    
    .dark-mode #capital-summary .text-light {
        color: var(--text-light) !important;
    }
    
    .dark-mode .monthly-report-div {
        background-color: #334155 !important;
    }
    .dark-mode .monthly-report-div h5, .dark-mode .monthly-report-div p {
        color: var(--text) !important;
    }
     .dark-mode .monthly-report-div span {
        color: var(--text-light) !important;
    }

    @media (max-width: 992px) {
        .header h1 {
            font-size: 2.2rem;
        }
        .header p {
            font-size: 1.1rem;
        }
    }
    
    @media (max-width: 768px) {
      .controls-bar {
        flex-direction: column;
        align-items: stretch;
      }
      .controls-bar > div {
        flex-direction: column;
      }
      .btn {
        width: 100%;
        justify-content: center;
      }
      
      .header h1 {
        font-size: 1.8rem;
      }
      
      .header p {
        font-size: 1rem;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      }
    }
    
    @media (max-width: 480px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
  <div class="main-container">
    <div class="header">
      <h1>💹 GPTrading Pro Dashboard</h1>
      <p>Sistema Avanzado de Gestión de Trading Binario con Análisis en Tiempo Real</p>
    </div>

    <div class="controls-bar">
      <div>
        <button class="btn btn-primary" onclick="toggleDarkMode()">🌓 Modo Oscuro</button>
        <button class="btn btn-secondary" onclick="exportToCSV()">📊 Exportar CSV</button>
        <label for="csv-input" class="btn btn-primary" style="margin: 0; cursor: pointer; justify-content: center;">
          <input type="file" id="csv-input" accept=".csv" style="display: none;">
          📁 Importar CSV
        </label>
        <button class="btn btn-success" onclick="refreshAll()">🔄 Actualizar</button>
      </div>
      <div>
        <button class="btn btn-danger" onclick="clearAllData()">🗑️ Limpiar Todo</button>
        <button class="btn btn-primary" onclick="showCalculator()">🧮 Calculadora</button>
      </div>
    </div>
    
    <div class="card">
        <h2>📊 Resumen de Estadísticas Globales</h2>
        <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="total-initial-capital">$0.00</div>
              <div class="stat-label">Capital Inicial Total</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="total-current-capital">$0.00</div>
              <div class="stat-label">Capital Actual Total</div>
            </div>
            <div class="stat-card profit" id="total-gain-card">
              <div class="stat-value" id="total-gain">$0.00</div>
              <div class="stat-label">Ganancia Total ($)</div>
            </div>
            <div class="stat-card loss" id="total-loss-card">
              <div class="stat-value" id="total-loss">$0.00</div>
              <div class="stat-label">Pérdida Total ($)</div>
            </div>
            <div class="stat-card" id="net-profit-card">
              <div class="stat-value" id="total-net-profit">$0.00</div>
              <div class="stat-label">Ganancia Neta Total</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="daily-profit">$0.00</div>
              <div class="stat-label">Ganancia Diaria Total</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="monthly-profit">$0.00</div>
              <div class="stat-label">Ganancia Mensual Total</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="success-rate">0%</div>
              <div class="stat-label">Tasa de Éxito Total</div>
            </div>
        </div>
    </div>
    
    <div class="card">
        <h2>📊 Resumen de Estadísticas por Cuenta</h2>
        <div id="account-stats-summary">
            </div>
    </div>

    <div class="calculator-widget" id="calculator-widget" style="display: none;">
      <h3>🧮 Calculadora de Porcentajes Avanzada</h3>
      <div class="calculator-grid">
        <div class="input-group">
          <label>Capital Inicial ($)</label>
          <input type="number" class="form-control" id="calc-initial" placeholder="1000">
        </div>
        <div class="input-group">
          <label>Capital Final ($)</label>
          <input type="number" class="form-control" id="calc-final" placeholder="1200">
        </div>
      </div>
      <button class="btn btn-success" onclick="calculateProfit()" style="margin-top: 15px;">Calcular Rendimiento</button>
      <div class="calc-result" id="calc-result" style="display: none;">
        <h4>Resultados del Análisis:</h4>
        <p id="profit-amount"></p>
        <p id="profit-percentage"></p>
        <p id="profit-analysis"></p>
      </div>
    </div>

    <div class="card">
      <h2>➕ Agregar Nueva Operación</h2>
      <div class="form-grid">
        <div class="input-group">
          <label>Cuenta</label>
          <select class="form-control" id="account-select">
            <option value="">Seleccionar cuenta</option>
          </select>
        </div>
        <div class="input-group">
          <label>Fecha</label>
          <input type="date" class="form-control" id="input-date">
        </div>
        <div class="input-group">
          <label>Operaciones Ganadas</label>
          <input type="number" class="form-control" id="input-win" placeholder="5" min="0">
        </div>
        <div class="input-group">
          <label>Operaciones Perdidas</label>
          <input type="number" class="form-control" id="input-loss" placeholder="2" min="0">
        </div>
        <div class="input-group">
          <label>Ganancia ($)</label>
          <input type="number" class="form-control" id="input-gain" placeholder="300.00" step="0.01" min="0">
        </div>
        <div class="input-group">
          <label>Pérdida ($)</label>
          <input type="number" class="form-control" id="input-loss-amount" placeholder="50.00" step="0.01" min="0">
        </div>
      </div>
      <button class="btn btn-success" onclick="addOperation()">✅ Agregar Operación</button>
    </div>

    <div class="card">
      <h2>🏦 Gestión de Cuentas</h2>
      <div class="form-grid">
        <div class="input-group">
          <label>Nombre de la Cuenta</label>
          <input type="text" class="form-control" id="new-account-name" placeholder="Mi Cuenta Principal">
        </div>
        <div class="input-group">
          <label>Capital Inicial ($)</label>
          <input type="number" class="form-control" id="new-account-balance" placeholder="1000.00" step="0.01" min="0">
        </div>
      </div>
      <button class="btn btn-primary" onclick="addAccount()">🏦 Crear Cuenta</button>
      <div class="mt-4" style="margin-top: 30px;">
        <h3>📊 Resumen de Reportes Mensuales</h3>
        <div id="monthly-reports-summary" style="margin-top: 15px;"></div>
      </div>
    </div>

    <div class="card">
      <h2>🔍 Filtros y Búsqueda</h2>
      <div class="form-grid">
        <div class="input-group">
          <label>Filtrar por Cuenta</label>
          <select class="form-control" id="filter-account">
            <option value="">Todas las cuentas</option>
          </select>
        </div>
        <div class="input-group">
          <label>Fecha Desde</label>
          <input type="date" class="form-control" id="filter-start">
        </div>
        <div class="input-group">
          <label>Fecha Hasta</label>
          <input type="date" class="form-control" id="filter-end">
        </div>
        <div class="input-group" style="align-self: flex-end;">
          <button class="btn btn-primary" onclick="applyFilters()">🔍 Aplicar Filtros</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h2 id="daily-report-title">🗓️ Resumen de Operaciones</h2>
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>Cuenta</th>
              <th>Ganadas</th>
              <th>Perdidas</th>
              <th>Ganancia ($)</th>
              <th>Pérdida ($)</th>
              <th>Neto ($)</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="daily-operations-table">
          </tbody>
        </table>
      </div>
    </div>
    
    <div class="card">
      <h2>📜 Historial Completo de Operaciones</h2>
      <div class="table-container">
        <table class="table">
            <thead>
            <tr>
                <th>Cuenta</th>
                <th>Fecha</th>
                <th>Ganadas</th>
                <th>Perdidas</th>
                <th>Ganancia ($)</th>
                <th>Pérdida ($)</th>
                <th>Neto ($)</th>
                <th>Rendimiento (%)</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
            </thead>
            <tbody id="operations-table">
            </tbody>
        </table>
      </div>
    </div>

    <div class="card" id="profit-chart-card">
        <h2>📈 Análisis de Rendimiento</h2>
        <div class="chart-container">
            <canvas id="profitChart"></canvas>
        </div>
    </div>

    <div class="card" id="monthly-chart-card">
        <h2>📊 Evolución Mensual</h2>
        <div class="chart-container">
            <canvas id="monthlyChart"></canvas>
        </div>
    </div>

    <div class="card">
      <h2>💰 Resumen de Capital por Cuenta</h2>
      <div id="capital-summary"></div>
    </div>
  </div>

  <script>
    // Configuración y constantes
    const STORAGE_KEYS = {
      operations: 'gp_trading_operations_v3',
      accounts: 'gp_trading_accounts_v3',
      monthlyReports: 'gp_trading_monthly_reports_v1',
      operations_old: 'gp_trading_operations',
      accounts_old: 'gp_trading_accounts',
    };

    let profitChart, monthlyChart;

    // Funciones de utilidad
    const formatCurrency = (amount) => {
      return new Intl.NumberFormat('es-CO', {
        style: 'currency',
        currency: 'COP',
        minimumFractionDigits: 2
      }).format(amount);
    };

    const formatPercentage = (value) => {
      return `${value.toFixed(2)}%`;
    };

    const getTodayDate = () => {
      return new Date().toISOString().split('T')[0];
    };

    const getCurrentMonth = () => {
      return new Date().toISOString().slice(0, 7);
    };

    // Gestión de datos
    const loadData = (key) => {
      try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : [];
      } catch (error) {
        console.error('Error loading data:', error);
        return [];
      }
    };

    const saveData = (key, data) => {
      try {
        localStorage.setItem(key, JSON.stringify(data));
      } catch (error) {
        console.error('Error saving data:', error);
        alert('Error al guardar los datos. Verifica el espacio disponible.');
      }
    };

    const migrateData = () => {
      let oldOperations = loadData(STORAGE_KEYS.operations_old);
      let oldAccounts = loadData(STORAGE_KEYS.accounts_old);
      
      if (oldOperations.length > 0 || oldAccounts.length > 0) {
        if (oldOperations.length > 0) {
          saveData(STORAGE_KEYS.operations, oldOperations);
          localStorage.removeItem(STORAGE_KEYS.operations_old);
          console.log('Operaciones migradas exitosamente.');
        }
        
        if (oldAccounts.length > 0) {
          const migratedAccounts = oldAccounts.map(acc => ({
            ...acc,
            lastReportDate: acc.lastReportDate || new Date().toISOString().split('T')[0]
          }));
          saveData(STORAGE_KEYS.accounts, migratedAccounts);
          localStorage.removeItem(STORAGE_KEYS.accounts_old);
          console.log('Cuentas migradas exitosamente.');
        }
        
        showNotification('✅ Datos de versión anterior migrados exitosamente', 'success');
        refreshAll();
      }
    };

    // Gestión de cuentas
    const addAccount = () => {
      const name = document.getElementById('new-account-name').value.trim();
      const balance = parseFloat(document.getElementById('new-account-balance').value) || 0;

      if (!name) {
        showNotification('⚠️ Por favor ingresa un nombre para la cuenta', 'warning');
        return;
      }

      if (balance < 0) {
        showNotification('⚠️ El capital inicial debe ser mayor o igual a 0', 'warning');
        return;
      }

      const accounts = loadData(STORAGE_KEYS.accounts);
      
      if (accounts.find(acc => acc.name.toLowerCase() === name.toLowerCase())) {
        showNotification('⚠️ Ya existe una cuenta con ese nombre', 'warning');
        return;
      }

      const newAccount = {
        id: Date.now(),
        name,
        initialBalance: balance,
        currentBalance: balance,
        createdAt: new Date().toISOString(),
        lastReportDate: new Date().toISOString().split('T')[0]
      };
      
      accounts.push(newAccount);

      saveData(STORAGE_KEYS.accounts, accounts);
      updateAccountSelects();
      clearAccountForm();
      showNotification('✅ Cuenta creada exitosamente', 'success');
      refreshAll();
    };
    
    // NUEVA FUNCIÓN: Eliminar una cuenta
    const deleteAccount = (accountId) => {
        let accounts = loadData(STORAGE_KEYS.accounts);
        const accountToDelete = accounts.find(acc => acc.id === accountId);

        if (!accountToDelete) {
            showNotification('⚠️ No se encontró la cuenta a eliminar.', 'danger');
            return;
        }

        if (!confirm(`¿Estás seguro de que quieres eliminar la cuenta "${accountToDelete.name}"?\n¡ATENCIÓN! Se eliminarán también TODAS las operaciones asociadas a esta cuenta. Esta acción es irreversible.`)) {
            return;
        }

        // Filtrar para mantener todas las cuentas excepto la que se va a eliminar
        const updatedAccounts = accounts.filter(acc => acc.id !== accountId);
        saveData(STORAGE_KEYS.accounts, updatedAccounts);

        // Filtrar para mantener todas las operaciones excepto las de la cuenta eliminada
        let operations = loadData(STORAGE_KEYS.operations);
        const updatedOperations = operations.filter(op => op.account !== accountToDelete.name);
        saveData(STORAGE_KEYS.operations, updatedOperations);

        showNotification(`🗑️ Cuenta "${accountToDelete.name}" y sus operaciones han sido eliminadas.`, 'success');
        refreshAll();
    };

    // NUEVA FUNCIÓN: Actualizar una cuenta
    const updateAccount = (accountId) => {
        let accounts = loadData(STORAGE_KEYS.accounts);
        let operations = loadData(STORAGE_KEYS.operations);
        const accountIndex = accounts.findIndex(acc => acc.id === accountId);

        if (accountIndex === -1) {
            showNotification('⚠️ No se encontró la cuenta a actualizar.', 'danger');
            return;
        }

        const accountToUpdate = accounts[accountIndex];
        const oldName = accountToUpdate.name;

        const newName = prompt("Ingresa el nuevo nombre para la cuenta:", oldName);
        if (newName === null) return; // El usuario canceló
        if (newName.trim() === "") {
            showNotification("⚠️ El nombre de la cuenta no puede estar vacío.", "warning");
            return;
        }
        
        // Verificar si el nuevo nombre ya existe (y no es la cuenta actual)
        if (accounts.some(acc => acc.name.toLowerCase() === newName.trim().toLowerCase() && acc.id !== accountId)) {
            showNotification("⚠️ Ya existe otra cuenta con ese nombre.", "warning");
            return;
        }

        const newInitialBalanceStr = prompt("Ingresa el nuevo capital inicial:", accountToUpdate.initialBalance);
        if (newInitialBalanceStr === null) return; // El usuario canceló
        
        const newInitialBalance = parseFloat(newInitialBalanceStr);
        if (isNaN(newInitialBalance) || newInitialBalance < 0) {
            showNotification("⚠️ El capital inicial debe ser un número válido mayor o igual a cero.", "warning");
            return;
        }

        // Actualizar datos de la cuenta
        accountToUpdate.name = newName.trim();
        accountToUpdate.initialBalance = newInitialBalance;
        
        // Si el nombre cambió, actualizarlo en todas las operaciones asociadas
        if (oldName !== newName.trim()) {
            operations.forEach(op => {
                if (op.account === oldName) {
                    op.account = newName.trim();
                }
            });
            saveData(STORAGE_KEYS.operations, operations);
        }

        // Guardar la lista de cuentas actualizada
        saveData(STORAGE_KEYS.accounts, accounts);
        
        // Recalcular el balance actual y refrescar todo
        recalculateAccountBalances();
        showNotification(`✅ Cuenta "${newName.trim()}" actualizada exitosamente.`, 'success');
        refreshAll();
    };


    const clearAccountForm = () => {
      document.getElementById('new-account-name').value = '';
      document.getElementById('new-account-balance').value = '';
    };

    // Gestión de operaciones
    const addOperation = () => {
      const accountName = document.getElementById('account-select').value;
      const date = document.getElementById('input-date').value;
      const wins = parseInt(document.getElementById('input-win').value) || 0;
      const losses = parseInt(document.getElementById('input-loss').value) || 0;
      const gain = parseFloat(document.getElementById('input-gain').value) || 0;
      const lossAmount = parseFloat(document.getElementById('input-loss-amount').value) || 0;

      if (!accountName || !date) {
        showNotification('⚠️ Por favor completa todos los campos obligatorios (Cuenta y Fecha)', 'warning');
        return;
      }

      if (wins === 0 && losses === 0) {
        showNotification('⚠️ Debe tener al menos una operación ganada o perdida', 'warning');
        return;
      }

      if (wins > 0 && gain === 0) {
        if (!confirm('⚠️ Tienes operaciones ganadas pero no especificaste ganancia. ¿Continuar?')) return;
      }

      if (losses > 0 && lossAmount === 0) {
        if (!confirm('⚠️ Tienes operaciones perdidas pero no especificaste pérdida. ¿Continuar?')) return;
      }

      const operations = loadData(STORAGE_KEYS.operations);
      const netProfit = gain - lossAmount;
      const accounts = loadData(STORAGE_KEYS.accounts);
      const selectedAccount = accounts.find(acc => acc.name === accountName);
      if (!selectedAccount) {
        showNotification('⚠️ Cuenta no encontrada', 'danger');
        return;
      }

      const previousOperations = operations.filter(op => op.account === accountName && op.date < date);
      let balanceBeforeDay = selectedAccount.initialBalance;
      previousOperations.forEach(op => {
          balanceBeforeDay += (op.netProfit !== undefined ? op.netProfit : (op.gain || 0) - (op.lossAmount || 0));
      });
      
      const operationsToday = operations.filter(op => op.account === accountName && op.date === date);
      let balanceBeforeOp = balanceBeforeDay;
      operationsToday.forEach(op => {
          balanceBeforeOp += (op.netProfit !== undefined ? op.netProfit : (op.gain || 0) - (op.lossAmount || 0));
      });
      
      const totalOperations = wins + losses;
      const successRate = totalOperations > 0 ? (wins / totalOperations) * 100 : 0;
      const profitPercentage = balanceBeforeOp > 0 ? (netProfit / balanceBeforeOp) * 100 : 0;

      const newOperation = {
        id: Date.now(),
        account: accountName,
        date,
        wins,
        losses,
        gain,
        lossAmount,
        netProfit,
        successRate,
        profitPercentage,
        totalOperations,
        createdAt: new Date().toISOString()
      };

      operations.push(newOperation);
      saveData(STORAGE_KEYS.operations, operations);

      recalculateAccountBalances();
      clearOperationForm();
      refreshAll();
      showNotification('✅ Operación agregada exitosamente', 'success');
    };

    const recalculateAccountBalances = () => {
        const accounts = loadData(STORAGE_KEYS.accounts);
        const operations = loadData(STORAGE_KEYS.operations);

        accounts.forEach(account => {
            let currentBalance = account.initialBalance;
            const accountOperations = operations.filter(op => op.account === account.name).sort((a, b) => new Date(a.date) - new Date(b.date));
            accountOperations.forEach(op => {
                const netProfit = op.netProfit !== undefined ? op.netProfit : (op.gain || 0) - (op.lossAmount || 0);
                currentBalance += netProfit;
            });
            account.currentBalance = currentBalance;
        });

        saveData(STORAGE_KEYS.accounts, accounts);
    };

    const clearOperationForm = () => {
      document.getElementById('input-date').value = getTodayDate();
      document.getElementById('input-win').value = '';
      document.getElementById('input-loss').value = '';
      document.getElementById('input-gain').value = '';
      document.getElementById('input-loss-amount').value = '';
      document.getElementById('account-select').selectedIndex = 0;
    };

    const deleteOperation = (operationId) => {
      if (!confirm('¿Estás seguro de eliminar esta operación? Esta acción es irreversible.')) return;

      const operations = loadData(STORAGE_KEYS.operations);
      const operationIndex = operations.findIndex(op => op.id === operationId);
      
      if (operationIndex === -1) return;

      operations.splice(operationIndex, 1);
      saveData(STORAGE_KEYS.operations, operations);
      
      recalculateAccountBalances();
      refreshAll();
      showNotification('🗑️ Operación eliminada exitosamente', 'success');
    };

    const createMonthlyReport = (accountName) => {
      const accounts = loadData(STORAGE_KEYS.accounts);
      const account = accounts.find(acc => acc.name === accountName);
      
      if (!account) {
        showNotification('⚠️ Cuenta no encontrada', 'danger');
        return;
      }
      
      const lastReportDate = new Date(account.lastReportDate);
      const today = new Date();
      const diffTime = Math.abs(today - lastReportDate);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
      
      if (diffDays < 30) {
        showNotification(`⚠️ Deben pasar al menos 30 días. Días restantes: ${30 - diffDays}`, 'warning');
        return;
      }
      
      if (!confirm(`¿Generar reporte mensual para '${accountName}'? Esto archivará el rendimiento y reiniciará el capital de la cuenta.`)) {
        return;
      }
      
      const operations = loadData(STORAGE_KEYS.operations);
      const reports = loadData(STORAGE_KEYS.monthlyReports);
      const operationsForReport = operations.filter(op => op.account === accountName && new Date(op.date) > lastReportDate);
      
      const totalProfit = operationsForReport.reduce((sum, op) => sum + op.netProfit, 0);
      const initialCapital = account.initialBalance;
      const finalCapital = account.currentBalance;
      const totalProfitPercentage = initialCapital > 0 ? (totalProfit / initialCapital) * 100 : 0;
      
      const newReport = {
        id: Date.now(),
        accountName,
        startDate: lastReportDate.toISOString().split('T')[0],
        endDate: today.toISOString().split('T')[0],
        initialCapital,
        finalCapital,
        totalProfit,
        totalProfitPercentage,
        operations: operationsForReport
      };
      
      reports.push(newReport);
      saveData(STORAGE_KEYS.monthlyReports, reports);
      
      account.initialBalance = account.currentBalance;
      account.lastReportDate = today.toISOString().split('T')[0];
      saveData(STORAGE_KEYS.accounts, accounts);
      
      const remainingOperations = operations.filter(op => op.account !== accountName || new Date(op.date) <= lastReportDate);
      saveData(STORAGE_KEYS.operations, remainingOperations);
      
      refreshAll();
      showNotification(`✅ Reporte mensual creado para '${accountName}'.`, 'success');
    };

    const renderMonthlyReportsSummary = () => {
      const reports = loadData(STORAGE_KEYS.monthlyReports);
      const container = document.getElementById('monthly-reports-summary');
      
      container.innerHTML = '';
      
      if (reports.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--text-light);">No hay reportes mensuales archivados.</p>';
        return;
      }
      
      reports.sort((a, b) => new Date(b.endDate) - new Date(a.endDate)).forEach(report => {
        const reportDiv = document.createElement('div');
        reportDiv.className = 'monthly-report-div';
        reportDiv.style.cssText = `
          background: #f0f4f8;
          padding: 15px;
          border-radius: 10px;
          margin-bottom: 10px;
          border-left: 4px solid var(--secondary);
        `;
        
        reportDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <h5 style="margin: 0; font-weight: 600; color: #333;">Reporte de ${report.accountName}</h5>
            <span style="font-size: 12px; color: var(--text-light);">${report.startDate} a ${report.endDate}</span>
          </div>
          <p style="margin: 0; font-size: 14px; color: #555;">Capital Inicial: <strong style="font-weight: 600; color: #333;">${formatCurrency(report.initialCapital)}</strong></p>
          <p style="margin: 0; font-size: 14px; color: #555;">Capital Final: <strong style="font-weight: 600; color: #333;">${formatCurrency(report.finalCapital)}</strong></p>
          <p style="margin: 0; font-size: 14px; color: #555;">Ganancia Total: <strong style="font-weight: 600; color: ${report.totalProfit >= 0 ? 'var(--success)' : 'var(--danger)'};">${formatCurrency(report.totalProfit)} (${formatPercentage(report.totalProfitPercentage)})</strong></p>
        `;
        
        container.appendChild(reportDiv);
      });
    };

    // Importar y exportar
    const importFromCSV = (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            const lines = text.split('\n').filter(line => line.trim() !== '');
            if (lines.length <= 1) {
                showNotification('⚠️ El archivo CSV está vacío o solo contiene encabezados.', 'warning');
                return;
            }

            const header = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const requiredHeaders = ['Cuenta', 'Fecha', 'Ganadas', 'Perdidas', 'Ganancia ($)', 'Pérdida ($)', 'Balance Inicial Dia ($)'];
            const hasAllRequiredHeaders = requiredHeaders.every(h => header.includes(h));
            if (!hasAllRequiredHeaders) {
                showNotification(`⚠️ Encabezados requeridos faltantes: ${requiredHeaders.filter(h => !header.includes(h)).join(', ')}`, 'danger');
                return;
            }

            handleOperationsImport(lines, header);
        };
        reader.readAsText(file);
    };

    const handleOperationsImport = (lines, header) => {
      let accounts = loadData(STORAGE_KEYS.accounts);
      let operations = [];
      const importedAccountNames = new Set();
      const headerMap = {};
      header.forEach((h, i) => headerMap[h] = i);
      
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (line === '') continue;

        const parts = line.split(',');
        const accountName = parts[headerMap['Cuenta']].replace(/"/g, '').trim();
        const date = parts[headerMap['Fecha']].trim();
        const wins = parseInt(parts[headerMap['Ganadas']], 10) || 0;
        const losses = parseInt(parts[headerMap['Perdidas']], 10) || 0;
        const gain = parseFloat(parts[headerMap['Ganancia ($)']]) || 0;
        const lossAmount = parseFloat(parts[headerMap['Pérdida ($)']]) || 0;

        if (isNaN(wins) || isNaN(losses) || isNaN(gain) || isNaN(lossAmount) || !accountName || !date) {
            console.error('Línea de CSV inválida o incompleta:', line);
            continue;
        }
        
        importedAccountNames.add(accountName);
        const netProfit = gain - lossAmount;
        operations.push({
            id: Date.now() + i,
            account: accountName, date, wins, losses, gain, lossAmount, netProfit,
            successRate: 0, profitPercentage: 0, totalOperations: wins + losses,
            createdAt: new Date().toISOString()
        });
      }
      
      if (operations.length === 0) {
        showNotification('⚠️ No se encontraron operaciones válidas en el archivo CSV.', 'warning');
        return;
      }

      const existingOperations = loadData(STORAGE_KEYS.operations).filter(op => !importedAccountNames.has(op.account));
      const allOperations = [...existingOperations, ...operations];
      saveData(STORAGE_KEYS.operations, allOperations);
      
      importedAccountNames.forEach(accountName => {
        let existingAccount = accounts.find(acc => acc.name === accountName);
        const initialBalanceFromCsv = parseFloat(lines.find(l => l.includes(accountName)).split(',')[headerMap['Balance Inicial Dia ($)']]) || 0;

        if (existingAccount) {
          existingAccount.initialBalance = initialBalanceFromCsv;
        } else {
          accounts.push({
            id: Date.now(), name: accountName, initialBalance: initialBalanceFromCsv,
            currentBalance: initialBalanceFromCsv, createdAt: new Date().toISOString(),
            lastReportDate: new Date().toISOString().split('T')[0]
          });
        }
      });
      saveData(STORAGE_KEYS.accounts, accounts);

      recalculateAccountBalances();
      refreshAll();
      showNotification(`✅ Se importaron ${operations.length} operaciones exitosamente.`, 'success');
    };
    
    const exportToCSV = () => {
        const operations = loadData(STORAGE_KEYS.operations);
        const accounts = loadData(STORAGE_KEYS.accounts);
        
        if (operations.length === 0 && accounts.length === 0) {
            showNotification('⚠️ No hay datos para exportar', 'warning');
            return;
        }

        const headers = ['Cuenta', 'Fecha', 'Ganadas', 'Perdidas', 'Ganancia ($)', 'Pérdida ($)', 'Neto ($)', 'Balance Inicial Dia ($)', 'Balance Final Dia ($)'];
        const csvLines = [headers.join(',')];

        const operationsByAccount = operations.reduce((acc, op) => {
            if (!acc[op.account]) acc[op.account] = [];
            acc[op.account].push(op);
            return acc;
        }, {});

        Object.keys(operationsByAccount).forEach(accountName => {
            operationsByAccount[accountName].sort((a, b) => new Date(a.date) - new Date(b.date) || a.id - b.id);
        });

        accounts.forEach(account => {
            const accountOperations = operationsByAccount[account.name] || [];
            let runningBalance = account.initialBalance || 0;

            if (accountOperations.length === 0) {
                csvLines.push([`"${account.name}"`, 'N/A', '0', '0', '0.00', '0.00', '0.00', runningBalance.toFixed(2), account.currentBalance.toFixed(2)].join(','));
                return;
            }

            accountOperations.forEach(op => {
                const balanceBefore = runningBalance;
                const netProfit = op.netProfit !== undefined ? op.netProfit : (op.gain || 0) - (op.lossAmount || 0);
                runningBalance += netProfit;
                csvLines.push([`"${op.account}"`, op.date, op.wins, op.losses, (op.gain || 0).toFixed(2), (op.lossAmount || 0).toFixed(2), netProfit.toFixed(2), balanceBefore.toFixed(2), runningBalance.toFixed(2)].join(','));
            });
        });
        
        const csvContent = csvLines.join('\n');
        const blob = new Blob([`\uFEFF${csvContent}`], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `operaciones_trading_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        showNotification('✅ Datos exportados exitosamente', 'success');
    };


    // Actualización de UI
    const updateAccountSelects = () => {
      const accounts = loadData(STORAGE_KEYS.accounts);
      const selects = ['account-select', 'filter-account'];
      
      selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        const currentValue = select.value;
        select.innerHTML = selectId === 'filter-account' ? 
          '<option value="">Todas las cuentas</option>' : 
          '<option value="">Seleccionar cuenta</option>';
        
        accounts.sort((a,b) => a.name.localeCompare(b.name)).forEach(account => {
          const option = document.createElement('option');
          option.value = account.name;
          option.textContent = `${account.name} (${formatCurrency(account.currentBalance)})`;
          select.appendChild(option);
        });
        select.value = currentValue;
      });
    };

    const updateStatistics = () => {
      const operations = loadData(STORAGE_KEYS.operations);
      const accounts = loadData(STORAGE_KEYS.accounts);
      const today = getTodayDate();
      const currentMonth = getCurrentMonth();

      const totalInitialCapital = accounts.reduce((sum, acc) => sum + (acc.initialBalance || 0), 0);
      const totalCurrentCapital = accounts.reduce((sum, acc) => sum + (acc.currentBalance || 0), 0);
      const totalGain = operations.reduce((sum, op) => sum + (op.gain || 0), 0);
      const totalLossAmount = operations.reduce((sum, op) => sum + (op.lossAmount || 0), 0);
      const totalNetProfit = totalGain - totalLossAmount;
      
      document.getElementById('total-initial-capital').textContent = formatCurrency(totalInitialCapital);
      document.getElementById('total-current-capital').textContent = formatCurrency(totalCurrentCapital);
      document.getElementById('total-net-profit').textContent = formatCurrency(totalNetProfit);
      document.getElementById('total-gain').textContent = formatCurrency(totalGain);
      document.getElementById('total-loss').textContent = formatCurrency(totalLossAmount);
      
      const netProfitCard = document.getElementById('net-profit-card');
      netProfitCard.classList.remove('profit', 'loss');
      if (totalNetProfit > 0) netProfitCard.classList.add('profit');
      else if (totalNetProfit < 0) netProfitCard.classList.add('loss');

      const dailyProfit = operations.filter(op => op.date === today).reduce((sum, op) => sum + (op.netProfit || 0), 0);
      document.getElementById('daily-profit').textContent = formatCurrency(dailyProfit);

      const monthlyProfit = operations.filter(op => op.date.startsWith(currentMonth)).reduce((sum, op) => sum + (op.netProfit || 0), 0);
      document.getElementById('monthly-profit').textContent = formatCurrency(monthlyProfit);

      const totalWins = operations.reduce((sum, op) => sum + op.wins, 0);
      const totalLosses = operations.reduce((sum, op) => sum + op.losses, 0);
      const totalOps = totalWins + totalLosses;
      const successRate = totalOps > 0 ? (totalWins / totalOps) * 100 : 0;
      document.getElementById('success-rate').textContent = formatPercentage(successRate);
    };

    const renderAccountStatsSummary = () => {
        const accounts = loadData(STORAGE_KEYS.accounts);
        const operations = loadData(STORAGE_KEYS.operations);
        const container = document.getElementById('account-stats-summary');
        container.innerHTML = '';

        if (accounts.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: var(--text-light);">No hay cuentas registradas.</p>';
          return;
        }

        accounts.forEach(account => {
            const accountOperations = operations.filter(op => op.account === account.name);
            const totalGain = accountOperations.reduce((sum, op) => sum + (op.gain || 0), 0);
            const totalLossAmount = accountOperations.reduce((sum, op) => sum + (op.lossAmount || 0), 0);
            const netProfit = totalGain - totalLossAmount;
            const totalWins = accountOperations.reduce((sum, op) => sum + op.wins, 0);
            const totalLosses = accountOperations.reduce((sum, op) => sum + op.losses, 0);
            const successRate = (totalWins + totalLosses) > 0 ? (totalWins / (totalWins + totalLosses)) * 100 : 0;
            const dailyProfit = accountOperations.filter(op => op.date === getTodayDate()).reduce((sum, op) => sum + (op.netProfit || 0), 0);
            const monthlyProfit = accountOperations.filter(op => op.date.startsWith(getCurrentMonth())).reduce((sum, op) => sum + (op.netProfit || 0), 0);

            const accountSummaryCard = document.createElement('div');
            accountSummaryCard.classList.add('card');
            accountSummaryCard.style.cssText = 'padding: 20px; margin-top: 20px;';
            accountSummaryCard.innerHTML = `
                <h3 style="margin-bottom: 20px; color: var(--primary);">${account.name}</h3>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-value">${formatCurrency(account.initialBalance)}</div><div class="stat-label">Capital Inicial</div></div>
                    <div class="stat-card"><div class="stat-value">${formatCurrency(account.currentBalance)}</div><div class="stat-label">Capital Actual</div></div>
                    <div class="stat-card profit"><div class="stat-value">${formatCurrency(totalGain)}</div><div class="stat-label">Ganancia Total</div></div>
                    <div class="stat-card loss"><div class="stat-value">${formatCurrency(totalLossAmount)}</div><div class="stat-label">Pérdida Total</div></div>
                    <div class="stat-card ${netProfit >= 0 ? 'profit' : 'loss'}"><div class="stat-value">${formatCurrency(netProfit)}</div><div class="stat-label">Ganancia Neta</div></div>
                    <div class="stat-card ${dailyProfit >= 0 ? 'profit' : 'loss'}"><div class="stat-value">${formatCurrency(dailyProfit)}</div><div class="stat-label">Ganancia Hoy</div></div>
                    <div class="stat-card ${monthlyProfit >= 0 ? 'profit' : 'loss'}"><div class="stat-value">${formatCurrency(monthlyProfit)}</div><div class="stat-label">Ganancia Mes</div></div>
                    <div class="stat-card ${successRate >= 50 ? 'profit' : 'loss'}"><div class="stat-value">${formatPercentage(successRate)}</div><div class="stat-label">Tasa de Éxito</div></div>
                </div>`;
            container.appendChild(accountSummaryCard);
        });
    };

    const renderDailyOperationsTable = (operationsToRender) => {
      const tbody = document.getElementById('daily-operations-table');
      tbody.innerHTML = '';
      
      const title = document.getElementById('daily-report-title');
      const startDate = document.getElementById('filter-start').value;
      const endDate = document.getElementById('filter-end').value;
      title.textContent = (startDate && endDate) ? `🗓️ Reporte de Operaciones (${startDate === endDate ? startDate : `${startDate} a ${endDate}`})` : '🗓️ Resumen de Operaciones';

      if (operationsToRender.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: var(--text-light);">No hay operaciones para el periodo seleccionado.</td></tr>`;
        return;
      }
      
      operationsToRender.forEach(op => {
        const row = document.createElement('tr');
        const netProfit = op.netProfit !== undefined ? op.netProfit : (op.gain || 0) - (op.lossAmount || 0);
        row.innerHTML = `
          <td><strong>${op.account}</strong></td>
          <td><span class="badge badge-success">${op.wins}</span></td>
          <td><span class="badge badge-danger">${op.losses}</span></td>
          <td style="color: var(--success); font-weight: 600;">${formatCurrency(op.gain || 0)}</td>
          <td style="color: var(--danger); font-weight: 600;">${formatCurrency(op.lossAmount || 0)}</td>
          <td style="font-weight: 600; color: ${netProfit >= 0 ? 'var(--success)' : 'var(--danger)'}">${formatCurrency(netProfit)}</td>
          <td><button class="btn btn-danger" onclick="deleteOperation(${op.id})" style="padding: 6px 12px; font-size: 12px;">🗑️</button></td>
        `;
        tbody.appendChild(row);
      });
    };

    const renderOperationsTable = (operationsToRender) => {
      const tbody = document.getElementById('operations-table');
      tbody.innerHTML = '';
      
      operationsToRender.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(op => {
        const row = document.createElement('tr');
        const netProfit = op.netProfit !== undefined ? op.netProfit : (op.gain || 0) - (op.lossAmount || 0);
        const isProfit = netProfit >= 0;
        row.innerHTML = `
          <td><strong>${op.account}</strong></td>
          <td>${op.date}</td>
          <td><span class="badge badge-success">${op.wins}</span></td>
          <td><span class="badge badge-danger">${op.losses}</span></td>
          <td style="color: var(--success); font-weight: 600;">${formatCurrency(op.gain || 0)}</td>
          <td style="color: var(--danger); font-weight: 600;">${formatCurrency(op.lossAmount || 0)}</td>
          <td style="font-weight: 600; color: ${isProfit ? 'var(--success)' : 'var(--danger)'}">${formatCurrency(netProfit)}</td>
          <td>${formatPercentage(op.profitPercentage || 0)}</td>
          <td><span class="badge ${isProfit ? 'badge-success' : 'badge-danger'}">${isProfit ? 'Ganancia' : 'Pérdida'}</span></td>
          <td><button class="btn btn-danger" onclick="deleteOperation(${op.id})" style="padding: 6px 12px; font-size: 12px;">🗑️</button></td>
        `;
        tbody.appendChild(row);
      });
    };

    const getFilteredOperations = () => {
      const operations = loadData(STORAGE_KEYS.operations);
      const accountFilter = document.getElementById('filter-account').value;
      const startDate = document.getElementById('filter-start').value;
      const endDate = document.getElementById('filter-end').value;

      return operations.filter(op => 
        (!accountFilter || op.account === accountFilter) &&
        (!startDate || op.date >= startDate) &&
        (!endDate || op.date <= endDate)
      );
    };

    const renderCapitalSummary = () => {
        const accounts = loadData(STORAGE_KEYS.accounts);
        const container = document.getElementById('capital-summary');
        container.innerHTML = '';

        if (accounts.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: var(--text-light);">No hay cuentas registradas.</p>';
            return;
        }

        const totalCapital = accounts.reduce((sum, acc) => sum + (acc.currentBalance || 0), 0);

        accounts.forEach(account => {
            const percentage = totalCapital > 0 ? ((account.currentBalance || 0) / totalCapital) * 100 : 0;
            const initialBalance = account.initialBalance || 0;
            const totalProfit = (account.currentBalance || 0) - initialBalance;
            const profitPercentage = initialBalance > 0 ? (totalProfit / initialBalance) * 100 : 0;
            const escapedAccountName = account.name.replace(/'/g, "\\'");

            const accountDiv = document.createElement('div');
            accountDiv.className = 'account-div';
            accountDiv.style.cssText = `
                background: white; padding: 20px; border-radius: 15px; margin-bottom: 15px;
                box-shadow: var(--shadow); border-left: 5px solid var(--primary);
                display: flex; flex-direction: column; gap: 15px; transition: all 0.3s ease;
            `;

            accountDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <h4 style="color: var(--dark); margin: 0;">${account.name}</h4>
                    <span style="background: var(--primary); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                        ${formatPercentage(percentage)} del total
                    </span>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <div>
                        <p class="text-light" style="margin: 0; font-size: 12px;">Capital Inicial</p>
                        <p style="margin: 0; font-weight: 600; color: var(--text);">${formatCurrency(initialBalance)}</p>
                    </div>
                    <div>
                        <p class="text-light" style="margin: 0; font-size: 12px;">Capital Actual</p>
                        <p style="margin: 0; font-weight: 600; color: var(--primary);">${formatCurrency(account.currentBalance)}</p>
                    </div>
                    <div>
                        <p class="text-light" style="margin: 0; font-size: 12px;">Ganancia/Pérdida</p>
                        <p style="margin: 0; font-weight: 600; color: ${totalProfit >= 0 ? 'var(--success)' : 'var(--danger)'};">
                            ${formatCurrency(totalProfit)} (${formatPercentage(profitPercentage)})
                        </p>
                    </div>
                </div>
                <div style="display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="createMonthlyReport('${escapedAccountName}')" style="padding: 8px 16px; font-size: 12px;">📈 Reporte Mensual</button>
                    <button class="btn btn-warning" onclick="updateAccount(${account.id})" style="padding: 8px 16px; font-size: 12px;">✏️ Actualizar</button>
                    <button class="btn btn-danger" onclick="deleteAccount(${account.id})" style="padding: 8px 16px; font-size: 12px;">🗑️ Eliminar</button>
                </div>
            `;
            container.appendChild(accountDiv);
        });

        const totalDiv = document.createElement('div');
        totalDiv.style.cssText = `
            background: var(--gradient-primary); color: white; padding: 25px;
            border-radius: 15px; text-align: center; margin-top: 20px;
        `;
        totalDiv.innerHTML = `
            <h4 style="margin: 0 0 10px 0; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1px;">💰 Capital Total Consolidado</h4>
            <p style="margin: 0; font-size: 2.5rem; font-weight: 700;">${formatCurrency(totalCapital)}</p>
        `;
        container.appendChild(totalDiv);
    };

    // --- SECCIÓN DE GRÁFICOS CORREGIDA ---
    const renderCharts = (operationsToRender) => {
        try {
            // Verifica si Chart.js está disponible. Si no, no intentes renderizar los gráficos.
            if (typeof Chart === 'undefined') {
                console.error('Chart.js no está cargado. Los gráficos no se mostrarán.');
                // Oculta las tarjetas de los gráficos para que el usuario no vea un espacio en blanco.
                document.getElementById('profit-chart-card').style.display = 'none';
                document.getElementById('monthly-chart-card').style.display = 'none';
                return; // Detiene la función aquí para no causar errores.
            }
            
            // Si Chart.js está disponible, asegúrate de que las tarjetas de los gráficos sean visibles.
            document.getElementById('profit-chart-card').style.display = 'block';
            document.getElementById('monthly-chart-card').style.display = 'block';

            const isDark = document.body.classList.contains('dark-mode');
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const fontColor = isDark ? '#e2e8f0' : '#334155';
            
            renderProfitChart(operationsToRender, gridColor, fontColor);
            renderMonthlyChart(operationsToRender, gridColor, fontColor);

        } catch (error) {
            console.error("Error al renderizar los gráficos:", error);
            // Si ocurre cualquier otro error, oculta los gráficos para no romper la app.
            document.getElementById('profit-chart-card').style.display = 'none';
            document.getElementById('monthly-chart-card').style.display = 'none';
        }
    };

    const renderProfitChart = (operations, gridColor, fontColor) => {
      const ctx = document.getElementById('profitChart').getContext('2d');
      if (profitChart) profitChart.destroy();

      const dailyData = {};
      operations.forEach(op => {
        dailyData[op.date] = (dailyData[op.date] || 0) + (op.netProfit !== undefined ? op.netProfit : (op.profit || 0));
      });

      const labels = Object.keys(dailyData).sort();
      const data = labels.map(date => dailyData[date]);

      profitChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels.map(date => new Date(date + 'T00:00:00').toLocaleDateString('es-ES', { day: 'numeric', month: 'short' })),
          datasets: [{
            label: 'Ganancia Neta Diaria ($)',
            data: data,
            borderColor: 'var(--primary)',
            backgroundColor: 'rgba(0, 102, 255, 0.1)',
            borderWidth: 3, fill: true, tension: 0.4
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { labels: { color: fontColor }}},
          scales: {
            y: { beginAtZero: true, ticks: { color: fontColor, callback: value => `$${value}` }, grid: { color: gridColor } },
            x: { ticks: { color: fontColor }, grid: { color: gridColor } }
          }
        }
      });
    };

    const renderMonthlyChart = (operations, gridColor, fontColor) => {
      const ctx = document.getElementById('monthlyChart').getContext('2d');
      if (monthlyChart) monthlyChart.destroy();

      const monthlyData = {};
      operations.forEach(op => {
        const month = op.date.substring(0, 7);
        monthlyData[month] = (monthlyData[month] || 0) + (op.netProfit !== undefined ? op.netProfit : (op.profit || 0));
      });

      const labels = Object.keys(monthlyData).sort();
      const data = labels.map(month => monthlyData[month]);

      monthlyChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels.map(month => {
            const [year, monthNum] = month.split('-');
            return new Date(year, monthNum - 1).toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
          }),
          datasets: [{
            label: 'Ganancia Mensual ($)',
            data: data,
            backgroundColor: data.map(value => value >= 0 ? 'rgba(34, 197, 94, 0.8)' : 'rgba(239, 68, 68, 0.8)'),
            borderColor: data.map(value => value >= 0 ? 'rgb(34, 197, 94)' : 'rgb(239, 68, 68)'),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { labels: { color: fontColor }}},
          scales: {
            y: { beginAtZero: true, ticks: { color: fontColor, callback: value => `$${value}` }, grid: { color: gridColor } },
            x: { ticks: { color: fontColor }, grid: { color: gridColor } }
          }
        }
      });
    };

    // Controles y utilidades
    const applyFilters = () => {
      const filteredOps = getFilteredOperations();
      renderDailyOperationsTable(filteredOps);
      renderOperationsTable(filteredOps);
      renderCharts(filteredOps);
    };
    
    const clearAllData = () => {
      if (!confirm('⚠️ ¿Estás seguro de eliminar TODOS los datos (cuentas y operaciones)? Esta acción no se puede deshacer.')) return;
      localStorage.removeItem(STORAGE_KEYS.operations);
      localStorage.removeItem(STORAGE_KEYS.accounts);
      localStorage.removeItem(STORAGE_KEYS.monthlyReports);
      showNotification('✅ Todos los datos han sido eliminados.', 'success');
      setTimeout(() => location.reload(), 1500);
    };

    const refreshAll = () => {
      updateAccountSelects();
      updateStatistics();
      renderAccountStatsSummary();
      renderCapitalSummary();
      renderMonthlyReportsSummary();
      applyFilters();
    };

    const toggleDarkMode = () => {
      document.body.classList.toggle('dark-mode');
      const isDark = document.body.classList.contains('dark-mode');
      localStorage.setItem('dark-mode', isDark);
      setTimeout(() => applyFilters(), 100);
    };

    const showCalculator = () => {
      const widget = document.getElementById('calculator-widget');
      widget.style.display = widget.style.display === 'none' ? 'block' : 'none';
    };

    const calculateProfit = () => {
      const initial = parseFloat(document.getElementById('calc-initial').value) || 0;
      const final = parseFloat(document.getElementById('calc-final').value) || 0;
      if (initial <= 0) {
        showNotification('⚠️ El capital inicial debe ser mayor a 0', 'warning');
        return;
      }

      const profit = final - initial;
      const percentage = (profit / initial) * 100;
      document.getElementById('profit-amount').textContent = `💰 Ganancia/Pérdida: ${formatCurrency(profit)}`;
      document.getElementById('profit-percentage').textContent = `📊 Porcentaje: ${formatPercentage(percentage)}`;
      
      let analysis = percentage > 20 ? '🚀 ¡Excelente rendimiento!' : percentage > 10 ? '📈 Buen rendimiento.' : percentage > 0 ? '✅ Rendimiento positivo.' : '📉 Pérdidas. Revisa tu estrategia.';
      document.getElementById('profit-analysis').textContent = `💡 ${analysis}`;
      document.getElementById('calc-result').style.display = 'block';
    };

    const showNotification = (message, type = 'success') => {
      const notification = document.createElement('div');
      let bgColor;
      switch(type) {
        case 'success': bgColor = 'var(--success)'; break;
        case 'danger': bgColor = 'var(--danger)'; break;
        case 'warning': bgColor = 'var(--warning)'; break;
        default: bgColor = 'var(--primary)';
      }
      notification.style.cssText = `
        position: fixed; top: 20px; right: 20px;
        background: ${bgColor}; color: white; padding: 15px 25px;
        border-radius: 10px; box-shadow: var(--shadow-lg); z-index: 1000;
        font-weight: 600; animation: slideInRight 0.5s ease-out;
      `;
      notification.textContent = message;
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 4000);
    };

    const initApp = () => {
      document.getElementById('input-date').value = getTodayDate();
      document.getElementById('csv-input').addEventListener('change', importFromCSV);

      const isDarkMode = localStorage.getItem('dark-mode') === 'true';
      if (isDarkMode) document.body.classList.add('dark-mode');
      
      migrateData();
      refreshAll();
      showNotification('🚀 Dashboard cargado exitosamente', 'success');
    };

    // Estilos de animación
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideInRight {
        from { transform: translateX(120%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
    `;
    document.head.appendChild(style);

    window.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>

</html>
